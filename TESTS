This file gives information on the tests that were made during the
Automake migration.

Environment
-----------
Arch Linux x64 with:
  - Autoconf 2.69
  - Automake 1.14.1
  - GNU Make 4.0

Current status
--------------
  - Gnulib integrated
  - Minimum Automake support
  - Build src/libs/*
  - Build src/utils/*
  - Build src/preproc/*
  - Build src/devices/*
  - Build src/roff/*
  - Build font/*
  - man files from 'man' directory installed
  - tmac files from 'tmac' directory installed
  - Build and installation of contrib:
    -- chem
    -- eqn2graph
    -- gdiffmk

Tests
-----

1. Generation of build system files

./bootstrap

Generated the following files and directories:
  INSTALL
  Makefile.in
  aclocal.m4
  autom4te.cache/
  build-aux/
  configure
  gnulib_m4/
  lib/
  src/include/config.hin

2. Tests of various targets

Tests done in 2 configurations:

  - Out-of source build mode

    mkdir build
    cd build
    ../configure

  - In source build:
    ../configure

2.1 make

Following files are generated:

  - src/include/config.h
  - lib/libgnu.a

from arch/misc:
  - shdeps.sed

from src/libs:
  - libbib.a
  - libdriver.a
  - libgroff.a, version.cpp and extra files (charset.alias,
    ref-add.sed, ref-del.sed)
  - libxutils.a

from src/utils:
  - addftinfo
  - afmtodit
  - hpftodit
  - indxbib
  - lkbib
  - lookbib
  - pfbtops
  - tfmtodit
  - xtotroff
  - man files (.n) in src/utils

from src/preproc:
  - eqn
  - grn
  - pre-grohtml
  - pic
  - preconv
  - refer
  - soelim
  - tbl
  - Yacc and Lex support: the following files are generated:
    -- eqn/eqn.cpp
    -- eqn/eqn.hpp (previously eqn_tab.h)
    -- pic/pic.cpp
    -- pic/pic.hpp (previously pic_tab.h)
    -- pic/pic.output
    -- refer/label.cpp
    -- refer/label.hpp
    Compared to the previous build system, the only relevant diff is
    an extra protection #define in label.cpp
#ifndef YY_YY_SRC_PREPROC_REFER_LABEL_HPP_INCLUDED
# define YY_YY_SRC_PREPROC_REFER_LABEL_HPP_INCLUDED

from src/devices:
  - grodvi
  - pre-grohtml
  - post-grohtml
  - grolbp
  - grolj4
  - gropdf
  - pdfmom
  - grops
  - grotty
  - gxditview

from src/roff
  - groff
  - grog
  - nroff
  - troff

from font: font files in 
  - devascii
  - devcp1047
  - devdvi
  - devhtml
  - devlatin1
  - devlbp
  - devlj4
  - devpdf
  - devps
  - devutf8

from contrib/chem:
  - `chem' script and 3 README files

from contrib/eqn2graph:
  - `eqn2graph' script

from contrib/gdiffmk:
  - `gdiffmk' script

In order to check and improve the dependencies, the following targets
were built from a clean environment:
  - make lib/libgnu.a
  - make libbib.a
  - make libdriver.a
  - make libgroff.a
  - make libxutil.a
  - make addftinfo
  - make  afmtodit
  - make hpftodit
  - make indxbib
  - make lkbib
  - make lookbib
  - make pfbtops
  - make tfmtodit
  - make xtotroff
  - make eqn
  - make grn
  - make pre-grohtml
  - make pic
  - make preconv
  - make refer
  - make soelim
  - make tbl
  - make grodvi
  - make post-grohtml
  - make grolbp
  - make grolj4
  - make gropdf
  - make pdfmom
  - make grops
  - make grotty
  - make gxditview
  - make groff
  - make grog
  - make nroff
  - make troff
  - make chem
  - make eqn2graph
  - make gdiffmk

2.2 make clean

The following files remain (this is expected):
  - Makefile
  - config.status
  - config.log
  - src/include/config.h
  - src/include/stamp-h1
  - .deps directories and .dirstamp files

2.3 make mostlyclean

  Like 'make clean', but the following files also remain (expected):
  - lib*.a
  - libgroff.a's charset.alias, ref-add.sed, ref-del.sed, and
    version.cpp.
  - gnulib's charset.alias, ref-add.sed, ref-del.sed and configmake.h
  - src/preproc generated .cpp, hpp, and .output files

Differences with former build system:

  - Programs and scripts (listed in bin_PROGRAMS bin_SCRIPTS) are not
    cleaned by 'make mostlyclean'. This could be changed if needed
    (MOSTLYCLEANFILES += $(bin_PROGRAMS)  $(bin_SCRIPTS)).

2.4 make distclean

  Like 'make clean', but the following files are also cleaned:
  - Makefile
  - config.status
  - config.log
  - src/include/config.h
  - src/include/stamp-h1
  - .deps directories and .dirstamp files

  In a out-of-source build, nothing remains in the build directory
  expect empty directories.

  The files generated by bootstrap and needed by the configure script
  are untouched:
  INSTALL
  Makefile.in
  aclocal.m4
  build-aux/
  configure
  gnulib_m4/
  lib/
  src/include/config.hin

2.5 make maintainer-clean

  Like 'make distclean'

2.6 make install

  mkdir -p ~/tmp/automake
  make install DESTDIR=~/tmp/automake

  - If file charset.alias is always present in
    $(DESTDIR)/usr/local/lib, make install update it by adding 'groff'
    to the list of programs using it. Otherwise nothing is installed.

  - Programs from 'src' installed in $(DESTDIR)/usr/local/bin: 

  - man files from man, src are installed in
    $(DESTDIR)/usr/local/share/man/man1, man5 and man7 (TODO:
    remaining man files from contrib)

  - $(DESTDIR)/usr/local/share/groff/1.22.3/eign (from src/utils/indxbib)

  - In $(DESTDIR)/usr/local/lib/X11/app-defaults: GXditview and
    GXditview-color. If these files are already present, they are
    first moved to GXditview.old and GXditview-color.old.

  - usr/local/lib/groff:
    -- groff_opts_no_arg.txt and groff_opts_with_arg.txt are installed
    -- grog/sub.pl

  - font files are installed in $(DESTDIR)/usr/local/groff/1.22.3/font
    and oldfont and identical to the one installed with the previous
    build system, except the fonts from devpdf which are not generated
    identically at each build.

  - tmac files from 'tmac' dir are installed in
    $(DESTDIR)/usr/local/groff/1.22.3/tmac. Some files are first
    stripped (comments removed) at build time. Checked that they are
    strictly identical to the one install by the original build
    system.
  
  - contrib scripts installed in $(DESTDIR)/usr/local/bin:
    -- chem
    -- eqn2graph
    -- gdiffmk

  - contrib/chem:

    -- chem.pic installed in
    $(DESTDIR)/usr/local/share/groff/1.22.3/pic/chem.pic

    -- other chem files installed in
    $(DESTDIR)/usr/local/share/doc/groff-1.22.3/examples, identical to
    the old build system.
    
    -- contrib/chem/README is strangely build but not installed, this
       is the behaviour on the old build system.

Diff with previous build system:
  - devcp1047 fonts are installed $(DESTDIR)/usr/local/groff/1.22.3/font

TODO: 

  - doc

  - examples from contrib

  - create the 'current' symlink

  - The original build system might uses tmac_s_prefix,
  tmac_an_prefix, tmac_wrap and sys_tmac_prefix during the
  installation of some tmac files but set these variables to an empty
  value in tmac/Makefile.sub, I don't quite understand how these
  variables could be set.

  - Add automake conditional for examples, html, and doc in `contrib'.

  - When contrib and doc will be completed, full installation tree
    comparison with the tree installed by the old build system

2.7 make uninstall

  - Tree after uninstall:
.
└── usr
    └── local
        ├── bin
        ├── lib
        │   └── X11
        │       └── app-defaults
        └── share
            ├── doc
            └── man
                ├── man1
                ├── man5
                └── man7

12 directories, 0 files

14 directories, 0 files

  - Notes:
    -- $(DESTDIR)/usr/local/lib/charset.alias is removed if exists
    -- $(DESTDIR)/usr/local/lib/X11/app-defaults/GXditview and
    GXditview-color are removed. However, GXditview.old and
    GXditview-color.old are not removed (this is the behaviour on the
    old build system)
  
2.8 make dist

  groff-1.22.3.tar.gz is generated.

  - Files/directories that are not distributed on purpose:
    .gitignore
    .gitmodules
    bootstrap
    bootstrap.conf
    gnulib/
    README.git
    TESTS

  - Missing files/directories (TODO):
    contrib/
    doc/
    test-groff.in

  - Files/directories not present in the git tree that are
    distributed:
    build-aux/
    gnulib_m4/
    lib/
    src/include/config.hin
    INSTALL
    Makefile.in
    aclocal.m4
    configure   
    src/preproc/eqn/eqn.cpp
    src/preproc/eqn/eqn.hpp
    src/preproc/pic/pic.cpp
    src/preproc/pic/pic.hpp 
    src/preproc/refer/label.hpp
    src/preproc/refere/label.cpp

2.9 make check
  
  (manually called automake --add-missing to add build-aux/test-driver)
  - gdiffmk's test script is now plugged to the 'make check'
    target. The original runtests.in is renamed to runtests.sh with
    absolute paths. The new script gdiffmk_tests.sh is used to call
    runtests.sh in $(top_builddir)/contrib/gdiff/tests, because
    runtest.sh will generate some result files.
  
2.10 make distcheck
  
  This will attempt to make a tarball, and from this tarball, build
the package(out-of-source build), check it, clean it (checking that no
file remains), install it, uninstall it (checking that no file remains
in the install tree).

  make distcheck

  - All phases now succeed

3. Additional tests

3.1 Build without X support

  Calling configure with option --without-x doesn't build:
  - gxidview
  - libxutil.a
  - xtotroff

  The following fonts are not installed: 
  - dev/X100
  - devX100-12
  - devX75
  - devX75-12
  
  'make distcheck' passes correctly, and the tarball generated by
  'make dist' is identical to the one generated with X support.

Notes
-----

  - Gnulib: some files of src/libs/libgroff could be replaced by their
    gnulib equivalent
  - Gnulib: git-version-gen could be used
